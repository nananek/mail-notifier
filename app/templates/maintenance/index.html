{% extends "base.html" %}
{% block title %}メンテナンス – Mail Notifier{% endblock %}

{% block content %}
<h2><i class="bi bi-gear"></i> メンテナンス</h2>
<hr>

<!-- ── Worker Control ────────────────────────────────────── -->
<div class="card mb-4">
  <div class="card-header"><i class="bi bi-cpu"></i> ワーカー制御</div>
  <div class="card-body">
    <div class="row align-items-center g-3">
      <div class="col-auto">
        <strong>ステータス:</strong>
        {% if state and state.is_running %}
          <span class="badge bg-success fs-6">稼働中</span>
        {% else %}
          <span class="badge bg-danger fs-6">停止中</span>
        {% endif %}
      </div>
      <div class="col-auto">
        <form method="post" action="{{ url_for('maintenance.toggle_worker') }}">
          {% if state and state.is_running %}
            <button class="btn btn-warning">
              <i class="bi bi-pause-fill"></i> ワーカーを停止
            </button>
          {% else %}
            <button class="btn btn-success">
              <i class="bi bi-play-fill"></i> ワーカーを再開
            </button>
          {% endif %}
        </form>
      </div>
    </div>

    <hr>

    <form method="post" action="{{ url_for('maintenance.set_interval') }}"
          class="row g-2 align-items-end" style="max-width:400px">
      <div class="col">
        <label for="poll_interval" class="form-label">ポーリング間隔（秒）</label>
        <input type="number" class="form-control" id="poll_interval" name="poll_interval"
               value="{{ state.poll_interval if state else 60 }}" min="10">
      </div>
      <div class="col-auto">
        <button class="btn btn-primary">
          <i class="bi bi-check-lg"></i> 設定
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ── Failure Logs ──────────────────────────────────────── -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span><i class="bi bi-exclamation-triangle"></i> 失敗ログ（最新100件）</span>
    <div>
      <form method="post" action="{{ url_for('maintenance.cleanup_old_logs') }}"
            class="d-inline">
        <button class="btn btn-sm btn-outline-warning">
          <i class="bi bi-clock-history"></i> 30日超を削除
        </button>
      </form>
      <form method="post" action="{{ url_for('maintenance.clear_logs') }}"
            class="d-inline ms-1"
            onsubmit="return confirm('すべての失敗ログを削除しますか？')">
        <button class="btn btn-sm btn-outline-danger">
          <i class="bi bi-trash"></i> すべて削除
        </button>
      </form>
    </div>
  </div>
  <div class="card-body p-0">
    {% if logs %}
    <div class="table-responsive">
      <table class="table table-sm table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>日時</th>
            <th>アカウント</th>
            <th>ルール</th>
            <th>From</th>
            <th>件名</th>
            <th>エラー</th>
          </tr>
        </thead>
        <tbody>
          {% for log in logs %}
          <tr>
            <td class="text-nowrap small">{{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            <td>{{ log.account.name if log.account else '-' }}</td>
            <td>{{ log.rule.name if log.rule else '-' }}</td>
            <td class="small">{{ log.from_address or '-' }}</td>
            <td class="small">{{ log.subject or '-' }}</td>
            <td class="text-danger small">{{ log.error_message }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted p-3 mb-0">失敗ログはありません。</p>
    {% endif %}
  </div>
</div>
{% endblock %}
