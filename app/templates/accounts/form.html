{% extends "base.html" %}
{% block title %}{{ 'アカウント編集' if account else '新規アカウント' }} – Mail Notifier{% endblock %}

{% block content %}
<h2>
  <i class="bi bi-person-badge"></i>
  {{ 'アカウント編集' if account else '新規アカウント' }}
</h2>
<hr>

<form method="post" class="row g-3" style="max-width:700px">
  <div class="col-12">
    <label for="name" class="form-label">表示名</label>
    <input type="text" class="form-control" id="name" name="name" required
           value="{{ account.name if account else '' }}"
           placeholder="例: Gmail / Proton Mail">
  </div>

  <div class="col-12">
    <label class="form-label">プロトコル</label>
    <div class="form-check form-check-inline">
      <input type="radio" class="form-check-input" id="protocol_imap" name="protocol_type"
             value="imap" {% if not account or account.protocol_type == 'imap' %}checked{% endif %}
             onchange="toggleProtocol()">
      <label class="form-check-label" for="protocol_imap">IMAP</label>
    </div>
    <div class="form-check form-check-inline">
      <input type="radio" class="form-check-input" id="protocol_pop3" name="protocol_type"
             value="pop3" {% if account and account.protocol_type == 'pop3' %}checked{% endif %}
             onchange="toggleProtocol()">
      <label class="form-check-label" for="protocol_pop3">POP3</label>
    </div>
  </div>

  <div class="col-md-8">
    <label for="imap_host" class="form-label" id="host_label">メールサーバー</label>
    <input type="text" class="form-control" id="imap_host" name="imap_host" required
           value="{{ account.imap_host if account else '' }}"
           placeholder="例: imap.gmail.com / 127.0.0.1">
  </div>
  <div class="col-md-4">
    <label for="imap_port" class="form-label">ポート</label>
    <input type="number" class="form-control" id="imap_port" name="imap_port"
           value="{{ account.imap_port if account else 993 }}">
  </div>

  <div class="col-md-6">
    <label for="imap_user" class="form-label">ユーザー名</label>
    <input type="text" class="form-control" id="imap_user" name="imap_user" required
           value="{{ account.imap_user if account else '' }}"
           placeholder="user@example.com">
  </div>
  <div class="col-md-6">
    <label for="imap_password" class="form-label">パスワード</label>
    <input type="password" class="form-control" id="imap_password" name="imap_password"
           {% if not account %}required{% endif %}
           placeholder="{{ '変更する場合のみ入力' if account else '' }}">
    {% if account %}
    <div class="form-text">空欄の場合は既存のパスワードを維持します。</div>
    {% endif %}
  </div>

  <div class="col-md-6" id="mailbox_section">
    <label for="mailbox_name" class="form-label">受信トレイ名</label>
    <div class="input-group">
      <input type="text" class="form-control" id="mailbox_name" name="mailbox_name" required
             value="{{ account.mailbox_name if account else 'INBOX' }}"
             placeholder="例: INBOX, Inbox, 受信トレイ">
      <button type="button" class="btn btn-outline-secondary" id="fetch-mailboxes">
        <i class="bi bi-search"></i> 一覧取得
      </button>
    </div>
    <div class="form-text">IMAP上の受信トレイ名。通常は「INBOX」ですが、サービスによって異なる場合があります。<br>
      「一覧取得」ボタンで利用可能なフォルダ名を取得できます。</div>
    <div id="mailbox-list" class="mt-2"></div>
  </div>

  <div class="col-md-6">
    <label for="ssl_mode" class="form-label">SSL/TLS接続方法</label>
    <select class="form-select" id="ssl_mode" name="ssl_mode">
      <option value="ssl" {% if not account or account.ssl_mode == 'ssl' %}selected{% endif %}>暗黙的SSL (ポート993/995)</option>
      <option value="starttls" {% if account and account.ssl_mode == 'starttls' %}selected{% endif %}>STARTTLS (Proton Bridge等)</option>
      <option value="none" {% if account and account.ssl_mode == 'none' %}selected{% endif %}>暗号化なし</option>
    </select>
    <div class="form-text">
      ・暗黙的SSL: IMAPS (993) / POP3S (995)<br>
      ・STARTTLS: Proton Mail Bridge等で使用<br>
      ・暗号化なし: 平文接続（非推奨）
    </div>
  </div>
{% block extra_js %}
<script>
document.getElementById('fetch-mailboxes').addEventListener('click', function() {
  const host = document.getElementById('imap_host').value;
  const port = document.getElementById('imap_port').value;
  const user = document.getElementById('imap_user').value;
  const password = document.getElementById('imap_password').value;
  const ssl_mode = document.getElementById('ssl_mode').value;
  const protocol_type = document.querySelector('input[name="protocol_type"]:checked').value;
  const btn = this;
  btn.disabled = true;
  btn.textContent = '取得中...';
  fetch('/accounts/mailboxes', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: `protocol_type=${encodeURIComponent(protocol_type)}&imap_host=${encodeURIComponent(host)}&imap_port=${encodeURIComponent(port)}&imap_user=${encodeURIComponent(user)}&imap_password=${encodeURIComponent(password)}&ssl_mode=${encodeURIComponent(ssl_mode)}`
  })
    .then(r => r.json())
    .then(data => {
      btn.disabled = false;
      btn.textContent = '一覧取得';
      const list = document.getElementById('mailbox-list');
      if (data.mailboxes && data.mailboxes.length) {
        list.innerHTML = '<strong>利用可能なフォルダ:</strong><ul>' + data.mailboxes.map(m => `<li><a href="#" onclick="document.getElementById('mailbox_name').value='${m}';return false;">${m}</a></li>`).join('') + '</ul>';
      } else {
        list.innerHTML = '<span class="text-danger">取得できませんでした。設定を確認してください。</span>';
      }
    })
    .catch(() => {
      btn.disabled = false;
      btn.textContent = '一覧取得';
      document.getElementById('mailbox-list').innerHTML = '<span class="text-danger">取得できませんでした。</span>';
    });
});

function toggleProtocol() {
  const isPop3 = document.getElementById('protocol_pop3').checked;
  const mailboxSection = document.getElementById('mailbox_section');
  const portInput = document.getElementById('imap_port');
  const hostLabel = document.getElementById('host_label');

  // Show/hide mailbox section
  mailboxSection.style.display = isPop3 ? 'none' : '';

  // Update host label
  hostLabel.textContent = isPop3 ? 'POP3サーバー' : 'IMAPサーバー';

  // Update default port if the current port is a known default
  const currentPort = parseInt(portInput.value);
  if (isPop3 && (currentPort === 993 || currentPort === 143)) {
    portInput.value = 995;
  } else if (!isPop3 && (currentPort === 995 || currentPort === 110)) {
    portInput.value = 993;
  }
}

// Run on page load to set initial state
document.addEventListener('DOMContentLoaded', toggleProtocol);
</script>
{% endblock %}

  <div class="col-12">
    <div class="form-check form-check-inline">
      <input type="checkbox" class="form-check-input" id="use_ssl" name="use_ssl"
             {% if not account or account.use_ssl %}checked{% endif %}>
      <label class="form-check-label" for="use_ssl">SSL/TLSを使用</label>
    </div>
    <div class="form-check form-check-inline">
      <input type="checkbox" class="form-check-input" id="enabled" name="enabled"
             {% if not account or account.enabled %}checked{% endif %}>
      <label class="form-check-label" for="enabled">有効</label>
    </div>
  </div>

  <div class="col-12 mt-4">
    <button type="submit" class="btn btn-primary">
      <i class="bi bi-check-lg"></i> 保存
    </button>
    <a href="{{ url_for('accounts.index') }}" class="btn btn-outline-secondary ms-2">
      キャンセル
    </a>
  </div>
</form>
{% endblock %}
